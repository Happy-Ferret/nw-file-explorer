var path = require('path');
var jade = require('jade');
var util = require("util");
var events = require("events");

// Template engine
var gen_bar = jade.compile([
    '- each item, i in sequence',
    '  - if (i != sequence.length - 1)',
    '    li(data-path="#{item.path}")',
    '      a(href="#") #{item.name}',
    '      span.divider /',
    '  - else',
    '    li.active(data-path="#{item.path}")',
    '      a(href="#") #{item.name}',
].join('\n'));

// Our real type
function AddressBar(element) {
  events.EventEmitter.call(this);
  this.element = element;
}

util.inherits(AddressBar, events.EventEmitter);

AddressBar.prototype.set = function(dir_path) {
  this.current_path = path.normalize(dir_path);

  // Split path into separate elements
  var sequence = this.current_path.split(path.sep);
  var result = [];

  var i = 0;
  if (sequence[0] == '')
    i = 1;
  for (; i < sequence.length; ++i) {
    result.push({
      name: sequence[i],
      path: sequence.slice(0, 1 + i).join(path.sep),
    });
  }

  this.element.html(gen_bar({ sequence: result }));
  this.register_events();
}

AddressBar.prototype.register_events = function(which) {
  var self = this;
  if (!which)
    which = self.element.find('a');

  // Click on the address bar
  which.click(function() {
    self.element.children('.active').removeClass('active');
    $(this).parent().addClass('active');

    self.emit('navigate', $(this).parent().attr('data-path'));

    return false;
  });
}

exports.AddressBar = AddressBar;
